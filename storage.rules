rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    function isValidImage() {
      return request.resource.contentType.matches('image/.*')
        && request.resource.contentType in [
            'image/jpeg',
            'image/png',
            'image/webp'
          ];
    }

    // {userId} は Firebase Authentication の UID
    match /profile_images/{userId}/{fileName} {
      allow read:  if request.auth != null;
      allow create, update: if request.auth != null
        && request.auth.uid == userId
        && isValidImage()
        && request.resource.size < 10 * 1024 * 1024;

      // delete では request.resource が null になるため参照しない。
      allow delete: if request.auth != null
        && request.auth.uid == userId;
    }

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
